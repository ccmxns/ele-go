# 状态持久化系统说明

## 功能概述

应用现在支持完整的状态持久化，包括：
- 🎨 **主题设置** (浅色/深色/系统)
- 👁️ **透明度状态** (开启/关闭 + 透明度值)
- 📌 **窗口置顶状态** (开启/关闭)
- ⚙️ **所有设置页面配置**

## 自动功能

### 应用启动时
- ✅ 自动加载上次保存的所有状态
- ✅ 恢复主题模式 (深色/浅色)
- ✅ 恢复窗口透明度设置
- ✅ 恢复窗口置顶状态

### 设置变更时
- ✅ 点击主题按钮 → 立即保存主题偏好
- ✅ 切换透明度 → 立即保存开启状态和透明度值
- ✅ 滚轮调节透明度 → 延迟保存 (500ms) 避免频繁写入
- ✅ 切换置顶状态 → 立即保存置顶偏好

## 测试方法

### 1. 主题持久化测试
1. 点击标题栏的主题按钮切换到深色模式
2. 关闭应用并重新启动
3. ✅ 验证：应用应该以深色模式启动

### 2. 透明度持久化测试
1. 点击透明度按钮激活透明度 (变蓝色)
2. 使用滚轮调节透明度到 50%
3. 关闭应用并重新启动
4. ✅ 验证：应用应该以 50% 透明度启动，透明度按钮为激活状态

### 3. 置顶状态持久化测试
1. 点击置顶按钮激活窗口置顶 (变蓝色)
2. 关闭应用并重新启动
3. ✅ 验证：应用应该处于置顶状态，置顶按钮为激活状态

### 4. 组合状态测试
1. 同时设置：深色主题 + 70% 透明度 + 窗口置顶
2. 关闭应用并重新启动
3. ✅ 验证：所有三个状态都应该被正确恢复

## 存储位置

设置文件保存在：
```
Windows: %APPDATA%/Electron Go App/settings.json
macOS: ~/Library/Application Support/Electron Go App/settings.json
Linux: ~/.config/Electron Go App/settings.json
```

## 设置文件结构

```json
{
  "general": {
    "alwaysOnTop": true
  },
  "appearance": {
    "theme": "dark",
    "windowOpacity": 70,
    "opacityEnabled": true
  },
  "hotkeys": {
    "hotkeyToggle": "",
    "hotkeyShow": "",
    "hotkeyHide": ""
  },
  "system": {
    "notifications": true
  },
  "server": {
    "port": 1313,
    "timeout": 30
  }
}
```

## 故障排除

### 如果状态没有保存
1. 检查控制台是否有错误信息
2. 确认用户目录有写权限
3. 手动删除设置文件重置为默认状态

### 如果恢复失败
1. 应用会自动降级到基本功能
2. 新的设置修改会重新创建设置文件
3. 检查设置文件是否为有效的 JSON 格式

## 开发者信息

### 核心组件
- `global-settings.js` - 全局设置管理器
- `titlebar.js` - 状态恢复和保存逻辑
- `main.js` - 设置文件 I/O 处理
- `preload.js` - 安全API桥接

### 调试命令
```javascript
// 在开发者工具中查看当前设置
console.log(window.globalSettings.getAll());

// 手动保存设置
await window.globalSettings.save();

// 获取特定设置
window.globalSettings.get('appearance.theme');
```